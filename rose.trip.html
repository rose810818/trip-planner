<!DOCTYPE html>
<html>
<head>
    <title>Google åœ°åœ–è¡Œç¨‹è¦åŠƒå™¨</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    
    <style>
        /* ç¢ºä¿ body å’Œ html ä½”æ»¿æ•´å€‹è¦–çª— */
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        /* ä¸»å®¹å™¨ï¼šä½¿ç”¨ Flexbox åŠƒåˆ†æ§åˆ¶é¢æ¿å’Œåœ°åœ– */
        #container {
            display: flex;
            height: 100vh; /* ç¢ºä¿å®¹å™¨ä½”æ»¿æ•´å€‹è¦–çª—é«˜åº¦ */
        }
        #controls {
            width: 350px;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f8f8;
            border-right: 1px solid #ddd;
        }
        #map {
            flex-grow: 1; /* è®“åœ°åœ–ä½”æ“šå‰©é¤˜æ‰€æœ‰ç©ºé–“ */
            height: 100%;
        }
        /* ä»‹é¢æ¨£å¼ */
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 12px;
            margin-left: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .add-button {
            background-color: #4CAF50;
            color: white;
            width: 100%;
            margin-left: 0;
            margin-bottom: 15px;
        }
        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        .waypoint-item span {
            font-weight: 600;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #results {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
        }
        .edit-controls {
            padding: 10px 0;
            border-top: 1px solid #ddd;
            margin-top: 10px;
            width: 100%;
        }
        .edit-controls button {
            margin: 2px;
        }
    </style>
</head>
<body>

    <div id="container">
        
        <div id="controls">
            <h2>ğŸ—ºï¸ è¡Œç¨‹è¦åŠƒå™¨</h2>
            
            <label for="travel-mode">äº¤é€šæ¨¡å¼:</label>
            <select id="travel-mode" onchange="calculateRoute()">
                <option value="DRIVING">é–‹è»Š</option>
                <option value="WALKING">æ­¥è¡Œ</option>
                <option value="BICYCLING">è‡ªè¡Œè»Š</option>
                <option value="TRANSIT">å¤§çœ¾é‹è¼¸</option>
            </select>
            
            <input type="text" id="place-input" placeholder="è¼¸å…¥åœ°é»åç¨±æˆ–åœ°å€">
            <button onclick="addWaypoint()" class="add-button">æ–°å¢åœ°é»</button>
            
            <hr style="border: 0; border-top: 1px solid #ddd;">
            
            <h3>ğŸ“ è¡Œç¨‹ç«™é» (å…± 0 é»)</h3>
            <div id="waypoints-list">
                <p id="list-placeholder">ç›®å‰æ²’æœ‰ä»»ä½•åœ°é»ã€‚</p>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #ddd;">

            <h3>â±ï¸ ç¸½è¨ˆ</h3>
            <div id="results">
                <p>ç¸½è·é›¢: <span id="total-distance">N/A</span></p>
                <p>ç¸½æ™‚é–“: <span id="total-duration">N/A</span></p>
            </div>
            
        </div>
        
        <div id="map"></div>
        
    </div> 
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVgcw4UGoWtWPM7d6-1zWB5iobP0PzOYA&libraries=places,geometry&callback=initMap">
    </script>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let map;
        let directionsService;
        let directionsRenderer;
        let autocomplete;
        let waypoints = [];             
        let waypointIdCounter = 0;      
        let selectedPlace = null;       
        let editingWaypointId = null;   

        // =================================================================
        // æ ¸å¿ƒåŠŸèƒ½ï¼šåˆå§‹åŒ–èˆ‡è³‡æ–™ç®¡ç†
        // =================================================================
        
        function initMap() {
            // å°ç£ä¸­å¿ƒåº§æ¨™
            const taiwan = { lat: 23.6978, lng: 120.9605 }; 
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: taiwan,
            });

            directionsService = new google.maps.DirectionsService();
            // å…è¨±ä½¿ç”¨è€…æ‹–æ›³åœ°åœ–ä¸Šçš„è·¯ç·š
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, draggable: true });
            
            directionsRenderer.addListener("directions_changed", () => {
                console.log("è·¯ç·šå·²è¢«æ‹–æ›³æ”¹è®Šã€‚");
            });

            const input = document.getElementById('place-input');
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);
            autocomplete.addListener('place_changed', onPlaceChanged);
            
            loadWaypoints();
        }
        
        function onPlaceChanged() {
            selectedPlace = autocomplete.getPlace();
        }

        function loadWaypoints() {
            try {
                const savedWaypoints = localStorage.getItem('plannerWaypoints');
                const savedIdCounter = localStorage.getItem('plannerIdCounter');
                
                if (savedWaypoints) {
                    const loadedData = JSON.parse(savedWaypoints);
                    
                    waypoints = loadedData.map(wp => ({
                        id: wp.id,
                        name: wp.name,
                        location: new google.maps.LatLng(wp.location.lat, wp.location.lng) 
                    }));
                    
                    if (savedIdCounter) {
                        waypointIdCounter = parseInt(savedIdCounter) + 1;
                    }

                    updateWaypointsList();
                    calculateRoute(); 
                }

            } catch (e) {
                console.warn("æœªæ‰¾åˆ°å„²å­˜çš„è¡Œç¨‹è³‡æ–™æˆ–è³‡æ–™ææ¯€ã€‚");
            }
        }
        
        function saveWaypoints() {
            try {
                // å°‡ LatLng ç‰©ä»¶è½‰æ›ç‚ºç´”ç²¹çš„ { lat, lng } ä»¥ä¾¿å„²å­˜
                const dataToSave = waypoints.map(wp => ({
                    id: wp.id,
                    name: wp.name,
                    location: { lat: wp.location.lat(), lng: wp.location.lng() }
                }));

                localStorage.setItem('plannerWaypoints', JSON.stringify(dataToSave));
                localStorage.setItem('plannerIdCounter', waypointIdCounter.toString());
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜åˆ° Local Storage:", e);
            }
        }

        // =================================================================
        // å¢/åˆª/ç·¨è¼¯åŠŸèƒ½
        // =================================================================

        function addWaypoint() {
            if (!selectedPlace || !selectedPlace.geometry) {
                alert("è«‹å¾å»ºè­°æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹æœ‰æ•ˆåœ°é»ï¼");
                return;
            }
            
            const newWaypoint = {
                id: waypointIdCounter++,
                name: selectedPlace.name || selectedPlace.formatted_address,
                location: selectedPlace.geometry.location
            };

            waypoints.push(newWaypoint);
            
            document.getElementById('place-input').value = '';
            selectedPlace = null;

            saveWaypoints();
            updateWaypointsList();
            calculateRoute();
        }

        function deleteWaypoint(id) {
            waypoints = waypoints.filter(wp => wp.id !== id);
            
            saveWaypoints();
            updateWaypointsList();
            calculateRoute();
        }

        function editWaypoint(id) {
            editingWaypointId = id;
            updateWaypointsList();
            
            const editInput = document.getElementById('edit-place-input');
            if (editInput) {
                editInput.focus();
                autocomplete = new google.maps.places.Autocomplete(editInput);
                autocomplete.addListener('place_changed', onPlaceChanged); 
                selectedPlace = null;
            }
        }

        function cancelEdit() {
            editingWaypointId = null;
            
            // ç¢ºä¿ Autocomplete ç¶å®šå›ä¸»è¦è¼¸å…¥æ¡†
            const mainInput = document.getElementById('place-input');
            autocomplete = new google.maps.places.Autocomplete(mainInput);
            autocomplete.addListener('place_changed', onPlaceChanged);
            selectedPlace = null; 
            
            updateWaypointsList();
        }

        function saveEditedWaypoint() {
            if (!editingWaypointId) return;
            
            if (!selectedPlace || !selectedPlace.geometry) {
                alert("è«‹å¾å»ºè­°æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„æ–°åœ°é»æ‰èƒ½å„²å­˜ï¼");
                return;
            }

            const index = waypoints.findIndex(wp => wp.id === editingWaypointId);

            if (index !== -1) {
                waypoints[index].name = selectedPlace.name || selectedPlace.formatted_address;
                waypoints[index].location = selectedPlace.geometry.location;
                
                editingWaypointId = null;
                
                cancelEdit(); 
                
                saveWaypoints();
                updateWaypointsList();
                calculateRoute();
            }
        }

        function updateWaypointsList() {
            const listContainer = document.getElementById('waypoints-list');
            listContainer.innerHTML = '';
            
            document.querySelector('#controls h3').innerHTML = `ğŸ“ è¡Œç¨‹ç«™é» (å…± ${waypoints.length} é»)`;
            
            if (waypoints.length === 0) {
                listContainer.innerHTML = '<p id="list-placeholder">ç›®å‰æ²’æœ‰ä»»ä½•åœ°é»ã€‚</p>';
                return;
            }

            waypoints.forEach((wp, index) => {
                const item = document.createElement('div');
                item.className = 'waypoint-item';
                
                const isEditing = wp.id === editingWaypointId;

                item.innerHTML = `
                    <span>**${index + 1}.** ${wp.name}</span>
                    <div>
                        <button onclick="editWaypoint(${wp.id})" ${isEditing ? 'disabled' : ''} style="background-color: #f0ad4e; color: white;">ç·¨è¼¯</button> 
                        <button onclick="deleteWaypoint(${wp.id})" ${isEditing ? 'disabled' : ''} style="background-color: #d9534f; color: white;">åˆªé™¤</button>
                    </div>
                `;
                listContainer.appendChild(item);

                if (isEditing) {
                     const editInputHtml = `
                        <div class="edit-controls">
                            <input type="text" id="edit-place-input" placeholder="é¸æ“‡æ–°åœ°é»...">
                            <button onclick="saveEditedWaypoint()" style="background-color: #5bc0de; color: white;">å„²å­˜è®Šæ›´</button>
                            <button onclick="cancelEdit()" style="background-color: #ccc;">å–æ¶ˆ</button>
                        </div>
                     `;
                     item.insertAdjacentHTML('afterend', editInputHtml);
                     document.getElementById('edit-place-input').value = wp.name; 
                }
            });
        }


        // =================================================================
        // è·¯å¾‘è¨ˆç®—èˆ‡ç¹ªè£½
        // =================================================================

        function calculateRoute() {
            if (waypoints.length < 2) {
                directionsRenderer.setDirections({ routes: [] });
                document.getElementById('total-distance').textContent = 'N/A';
                document.getElementById('total-duration').textContent = 'N/A';
                return;
            }

            const origin = waypoints[0].location;
            const destination = waypoints[waypoints.length - 1].location;
            
            // å°‡ä¸­é–“é»è½‰æ›ç‚º Directions æœå‹™æ‰€éœ€çš„æ ¼å¼
            const middleWaypoints = waypoints.slice(1, waypoints.length - 1).map(wp => ({
                location: wp.location,
                stopover: true 
            }));
            
            const selectedMode = document.getElementById('travel-mode').value;
            const travelMode = google.maps.TravelMode[selectedMode]; 

            const request = {
                origin: origin,
                destination: destination,
                waypoints: middleWaypoints,
                optimizeWaypoints: true, // è®“ Google è‡ªå‹•å„ªåŒ–ä¸­é€”é»çš„é †åº
                travelMode: travelMode
            };

            directionsService.route(request, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);

                    let totalDistance = 0;
                    let totalDuration = 0;
                    const route = response.routes[0];

                    route.legs.forEach(leg => {
                        totalDistance += leg.distance.value; 
                        totalDuration += leg.duration.value;
                    });
                    
                    document.getElementById('total-distance').textContent = (totalDistance / 1000).toFixed(2) + ' å…¬é‡Œ';
                    document.getElementById('total-duration').textContent = formatDuration(totalDuration);

                } else {
                    directionsRenderer.setDirections({ routes: [] });
                    document.getElementById('total-distance').textContent = 'è·¯ç·šè¦åŠƒå¤±æ•—';
                    document.getElementById('total-duration').textContent = `éŒ¯èª¤: ${status}`;
                }
            });
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            let result = '';
            if (hours > 0) result += hours + ' å°æ™‚ ';
            if (minutes > 0) result += minutes + ' åˆ†é˜';
            return result.trim() || 'å°‘æ–¼ 1 åˆ†é˜';
        }

    </script>
</body>
</html>
